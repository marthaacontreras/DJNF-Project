---
title: "Sunday paragraph"
output: html_document
date: "2024-06-02"
---
Initial data gathering questions I would like to answer:
Which private equity firms have the most amount of HCV leases? Least?
What is the overall average gross rent? Sum? Per year? 
What is the average gross rent of each firm? Sum? Per year?
What is the overall average HAP to Owner? Sum? Per year?
# What is the average HAP to each owner (firm)? Sum? Per year?
Net_lease = Gross_Rent - HAP_to_Owner   
What is the overall average of the net lease?Sum?Per year?
What is average gross of the net lease of each firm? Sum? Per year?

Data tasks I am not sure are feasible:
Categorizing addresses by nieghborhoods using their zipcodes
Comparing HAP leases to other lease prices in the same area (is there any exploitation of pricing happening?)

Non-data questions to further investigate:
On the Housing Assistance Payments (HAP Contract), it says that "During the
initial lease term, the owner may not raise the rent to owner."
    What is considered the initial lease term --> when can owners start raising the rent?
    Based on the time period, COMPARE IN DATA (ie if span is 1 year then search for trends in        rent changes using the same addresses) 
    --> unless the data set is only comprised of leases that begin, find this as well  
I believe my story lies in these answers, so my idea is to answer these questions and narrow into a specific topic concerning private equity firms and HAP leases as my results reveal the story. Essentially, see if any data revails private equity firms exploiting the housing market and the HAP program  

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rio)
library(janitor)
```

```{r}
CHA_2020_4 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2020Q4") %>% 
  mutate(quarter="2020Q4") %>% 
  clean_names()

CHA_2021_1 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2021Q1") %>% 
  mutate(quarter="2021Q1") %>% 
  clean_names()

CHA_2021_2 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2021Q2") %>% 
  mutate(quarter="2021Q2") %>% 
  clean_names()

CHA_2021_3 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2021Q3") %>% 
  mutate(quarter="2021Q3") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2021_4 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2021Q4") %>% 
  mutate(quarter="2021Q4") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2022_1 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2022Q1") %>% 
  mutate(quarter="2022Q1") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2022_2 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2022Q2") %>% 
  mutate(quarter="2022Q2") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2022_3 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2022Q3") %>% 
  mutate(quarter="2022Q3") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2022_4 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2022Q4") %>% 
  mutate(quarter="2022Q4") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2023_1 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2023Q1") %>% 
  mutate(quarter="2023Q1") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2023_2 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2023Q2") %>% 
  mutate(quarter="2023Q2") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2023_3 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2023Q3") %>% 
  mutate(quarter="2023Q3") %>% 
  clean_names() %>% 
  rename(vendor_id = vendor_i)

CHA_2023_4 <- rio::import("https://github.com/wellsdata/DJNF_Merrill/raw/main/data/CHA_Data_24_053R.xlsx", sheet = "2023Q4") %>% 
  mutate(quarter="2023Q4") %>% 
  clean_names() 
```

```{r}

combo <- rbind(CHA_2020_4, CHA_2021_1, CHA_2021_2, CHA_2021_3, CHA_2021_4, CHA_2022_1, CHA_2022_2, CHA_2022_3, CHA_2022_4)

write.csv(combo,"combo.csv")
```

```{r}

colnames(combo)

summary(combo$vendor_name)

combo %>% 
  count(vendor_name) %>% 
  arrange(desc(n)) %>% 
  head() 

leases_per_firm <- combo %>% 
  count(vendor_name) %>% 
  arrange(n) %>% 
  head()
 
write_csv(leases_per_firm, "leaeses_per_firm.csv")
```

```{r}

combo <-  combo %>% 
  mutate(gross_rent=as.numeric(gross_rent))

combo <-  combo %>% 
  mutate(Hap_to_Owner=as.numeric(hap_to_owner))

vendors <- combo %>% 
  select(vendor_name, gross_rent, Hap_to_Owner) %>% 
  group_by(vendor_name) %>% 
  summarize(
    Total_Gross_Rent = sum(gross_rent, na.rm=TRUE),
    #flawed (line below --> all Hap to Owner data not in the vendors_mean table is skewed)
    Total_Hap_to_Owner = sum(Hap_to_Owner, na.rm=TRUE),
    Mean_Gross_Rent = mean(gross_rent, na.rm=TRUE),
    #flawed (line below)
    Mean_Hap_to_Owner = mean(Hap_to_Owner, na.rm=TRUE)
    ) %>%  
  arrange(desc(Total_Gross_Rent))

#data excluding 2021Q2* from 2020Q4 to 2023Q4 (non skewed Hap to Owner data) 

vendors_mean <- combo %>% 
  select(vendor_name, gross_rent, Hap_to_Owner, quarter) %>% 
  group_by(vendor_name) %>% 
  filter(!quarter=="2021Q2") %>% 
  summarize(
    Total_Gross_Rent = sum(gross_rent, na.rm=TRUE),
    Total_Hap_to_Owner = sum(Hap_to_Owner, na.rm=TRUE), 
    Mean_Gross_Rent = mean(gross_rent, na.rm=TRUE),
    Mean_Hap_to_Owner = mean(Hap_to_Owner, na.rm=TRUE)
    ) %>%  
  arrange(desc(Mean_Hap_to_Owner))

summary(vendors$Total_Gross_Rent)

sum(vendors$Total_Gross_Rent, na.rm=TRUE)
mean(vendors$Total_Gross_Rent, na.rm=TRUE)
# F L A W E D   data 
sum(vendors$Total_Hap_to_Owner, na.rm=TRUE)
mean(vendors$Total_Hap_to_Owner, na.rm=TRUE)

#totals of data excluding 2021Q2* from 2020Q4 to 2023Q4 (non skewed)
sum(vendors_mean$Total_Gross_Rent, na.rm=TRUE)
mean(vendors_mean$Total_Gross_Rent, na.rm=TRUE)
sum(vendors_mean$Total_Hap_to_Owner, na.rm=TRUE)
mean(vendors_mean$Total_Hap_to_Owner, na.rm=TRUE)

#NET MONEY PROPERTY OWNERS RECEIVE FROM THE GOVERNMENT = (UTILITY + HAP TO OWNER)

```

```{r}

#calculations, every capitalized label is the numeric value (was previously processed as characters and had to mutate) 
# combo <- combo %>% 
#   mutate(Utility_Allowance=as.numeric(utility_allowance)) %>% 
#   mutate(total_subsidy=Hap_to_Owner+Utility_Allowance) %>% 
#   mutate(pct_gross_rent=total_subsidy/gross_rent) 

#^something went wrong here, but was previously working
#summary(combo$pct_gross_rent)
#arrange(desc(combo$Pct_Gross_Rent))


#calculate table for subsidy per firm and compare to average

git add . 
git commit -m "added new files" 
git push origin main


```


```
